<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Debug</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .status-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }
        
        .success { color: #4CAF50; }
        .error { color: #ff4444; }
        .warning { color: #FF9500; }
        .info { color: #2196F3; }
        
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        pre {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Dashboard Diagnostic Tool</h1>
    
    <div class="status-box">
        <h2>Step 1: Check D3.js Library</h2>
        <div id="d3-status">Checking...</div>
    </div>
    
    <div class="status-box">
        <h2>Step 2: Test Backend Connection</h2>
        <button onclick="testBackend()">Test Backend</button>
        <div id="backend-status"></div>
    </div>
    
    <div class="status-box">
        <h2>Step 3: Test API Endpoints</h2>
        <button onclick="testDatasets()">Test /api/datasets</button>
        <button onclick="testData()">Test /api/data</button>
        <div id="api-status"></div>
    </div>
    
    <div class="status-box">
        <h2>Step 4: Test Chart Rendering</h2>
        <button onclick="testChart()">Test Simple Chart</button>
        <div id="chart-test" style="min-height: 200px;"></div>
    </div>
    
    <div class="status-box">
        <h2>Console Output:</h2>
        <pre id="console-output"></pre>
    </div>

    <script>
        // Custom console log to display on page
        const outputDiv = document.getElementById('console-output');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}\n`;
            outputDiv.textContent += entry;
            console.log(message);
            
            // Auto-scroll to bottom
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        // Step 1: Check D3.js
        function checkD3() {
            const d3Status = document.getElementById('d3-status');
            if (typeof d3 !== 'undefined') {
                d3Status.innerHTML = '<span class="success">✓ D3.js loaded successfully (version ' + d3.version + ')</span>';
                log('D3.js version ' + d3.version + ' loaded');
                return true;
            } else {
                d3Status.innerHTML = '<span class="error">✗ D3.js failed to load</span>';
                log('ERROR: D3.js not loaded', 'error');
                return false;
            }
        }

        // Step 2: Test Backend
        async function testBackend() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = '<span class="info">Testing...</span>';
            
            try {
                log('Testing backend at http://127.0.0.1:5000/');
                const response = await fetch('http://127.0.0.1:5000/');
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <span class="success">✓ Backend is running</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Backend connection successful');
                } else {
                    throw new Error('Response not OK: ' + response.status);
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">✗ Cannot connect to backend: ${error.message}</span>`;
                log('ERROR: ' + error.message, 'error');
                
                // Check if it's a CORS error
                if (error.message.includes('Failed to fetch')) {
                    statusDiv.innerHTML += `
                        <div class="warning">
                            <br>⚠ This might be a CORS issue. Make sure you're accessing this page via:
                            <br>http://localhost:8080/debug.html (not file://)
                        </div>
                    `;
                }
            }
        }

        // Step 3: Test Datasets Endpoint
        async function testDatasets() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.innerHTML = '<span class="info">Testing /api/datasets...</span>';
            
            try {
                log('Fetching /api/datasets');
                const response = await fetch('http://127.0.0.1:5000/api/datasets');
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <span class="success">✓ Datasets endpoint works</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Found datasets: ' + Object.keys(data).join(', '));
                    
                    // Store for later use
                    window.datasetsMetadata = data;
                } else {
                    throw new Error('Response not OK: ' + response.status);
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">✗ Datasets endpoint error: ${error.message}</span>`;
                log('ERROR: ' + error.message, 'error');
            }
        }

        // Test Data Endpoint
        async function testData() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.innerHTML = '<span class="info">Testing /api/data...</span>';
            
            try {
                log('Fetching /api/data?dataset=eth&days=7');
                const response = await fetch('http://127.0.0.1:5000/api/data?dataset=eth&days=7');
                const data = await response.json();
                
                if (response.ok) {
                    const dataPoints = data.data ? data.data.length : 0;
                    statusDiv.innerHTML = `
                        <span class="success">✓ Data endpoint works (${dataPoints} data points)</span>
                        <pre>${JSON.stringify(data.metadata, null, 2)}</pre>
                    `;
                    log(`Received ${dataPoints} data points`);
                    
                    if (dataPoints === 0) {
                        statusDiv.innerHTML += '<div class="warning">⚠ No data returned - check API key</div>';
                    }
                    
                    // Store for chart test
                    window.testData = data;
                } else {
                    throw new Error('Response not OK: ' + response.status);
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">✗ Data endpoint error: ${error.message}</span>`;
                log('ERROR: ' + error.message, 'error');
            }
        }

        // Step 4: Test Chart Rendering
        function testChart() {
            const chartDiv = document.getElementById('chart-test');
            
            if (!checkD3()) {
                chartDiv.innerHTML = '<span class="error">Cannot test chart - D3.js not loaded</span>';
                return;
            }
            
            try {
                log('Testing D3 chart rendering');
                
                // Clear previous chart
                d3.select("#chart-test").selectAll("*").remove();
                
                // Create simple test data
                const data = [
                    {x: 0, y: 10},
                    {x: 1, y: 20},
                    {x: 2, y: 15},
                    {x: 3, y: 25},
                    {x: 4, y: 18}
                ];
                
                const width = 400;
                const height = 200;
                const margin = {top: 20, right: 20, bottom: 30, left: 40};
                
                const svg = d3.select("#chart-test")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .style("background", "#222");
                
                const xScale = d3.scaleLinear()
                    .domain([0, 4])
                    .range([margin.left, width - margin.right]);
                
                const yScale = d3.scaleLinear()
                    .domain([0, 30])
                    .range([height - margin.bottom, margin.top]);
                
                const line = d3.line()
                    .x(d => xScale(d.x))
                    .y(d => yScale(d.y));
                
                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "#4CAF50")
                    .attr("stroke-width", 2)
                    .attr("d", line);
                
                svg.selectAll("circle")
                    .data(data)
                    .enter().append("circle")
                    .attr("cx", d => xScale(d.x))
                    .attr("cy", d => yScale(d.y))
                    .attr("r", 4)
                    .attr("fill", "#4CAF50");
                
                chartDiv.innerHTML = '<span class="success">✓ D3 chart rendering works</span>' + chartDiv.innerHTML;
                log('Chart rendered successfully');
                
            } catch (error) {
                chartDiv.innerHTML = `<span class="error">✗ Chart rendering failed: ${error.message}</span>`;
                log('ERROR: ' + error.message, 'error');
            }
        }

        // Run initial check
        window.addEventListener('load', () => {
            setTimeout(checkD3, 100);
        });

        // Also log any global errors
        window.addEventListener('error', (event) => {
            log(`GLOBAL ERROR: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`UNHANDLED PROMISE REJECTION: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>